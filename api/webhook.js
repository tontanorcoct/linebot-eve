// api/webhook.js
import { Client, middleware } from '@line/bot-sdk';
import { differenceInCalendarDays, addDays } from 'date-fns';
import { getSheetData } from '../modules/googleSheets.js';
import OpenAI from 'openai';
import { extractTextFromImage } from '../modules/googleVision.js';
import { translateText, formatReport } from '../modules/translator.js';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

const config = {
  channelAccessToken: process.env.LINE_TOKEN,
  channelSecret: process.env.LINE_SECRET,
};
const client = new Client(config);

// Google Sheets
const SHEET_ID     = process.env.GOOGLE_SHEETS_SPREADSHEET_ID;
const POLICE_RANGE = `'Police'!A2:G100`;  // à¹à¸—à¹‡à¸šà¸Šà¸·à¹ˆà¸­ "Police"

// à¹€à¸”à¸·à¸­à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ â†’ à¸”à¸±à¸Šà¸™à¸µ 0â€“11
const monthMap = {
  '1':0,'01':0,'à¸¡à¸à¸£à¸²à¸„à¸¡':0,'à¸¡.à¸„.':0,'à¸¡.à¸„':0,
  '2':1,'02':1,'à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ':1,'à¸.à¸ž.':1,'à¸.à¸ž':1,
  '3':2,'03':2,'à¸¡à¸µà¸™à¸²à¸„à¸¡':2,'à¸¡à¸µ.à¸„.':2,'à¸¡à¸µ.à¸„':2,
  '4':3,'04':3,'à¹€à¸¡à¸©à¸²à¸¢à¸™':3,'à¹€à¸¡.à¸¢.':3,'à¹€à¸¡.à¸¢':3,
  '5':4,'05':4,'à¸žà¸¤à¸©à¸ à¸²à¸„à¸¡':4,'à¸ž.à¸„.':4,'à¸ž.à¸„':4,
  '6':5,'06':5,'à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™':5,'à¸¡à¸´.à¸¢.':5,'à¸¡à¸´.à¸¢':5,
  '7':6,'07':6,'à¸à¸£à¸à¸Žà¸²à¸„à¸¡':6,'à¸.à¸„.':6,'à¸.à¸„':6,
  '8':7,'08':7,'à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡':7,'à¸ª.à¸„.':7,'à¸ª.à¸„':7,
  '9':8,'09':8,'à¸à¸±à¸™à¸¢à¸²à¸¢à¸™':8,'à¸.à¸¢.':8,'à¸.à¸¢':8,
  '10':9,'à¸•à¸¸à¸¥à¸²à¸„à¸¡':9,'à¸•.à¸„.':9,'à¸•.à¸„':9,
  '11':10,'à¸žà¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™':10,'à¸ž.à¸¢.':10,'à¸ž.à¸¢':10,
  '12':11,'à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡':11,'à¸˜.à¸„.':11,'à¸˜.à¸„':11,
};
const thaiMonths = [
  'à¸¡à¸à¸£à¸²à¸„à¸¡','à¸à¸¸à¸¡à¸ à¸²à¸žà¸±à¸™à¸˜à¹Œ','à¸¡à¸µà¸™à¸²à¸„à¸¡','à¹€à¸¡à¸©à¸²à¸¢à¸™','à¸žà¸¤à¸©à¸ à¸²à¸„à¸¡','à¸¡à¸´à¸–à¸¸à¸™à¸²à¸¢à¸™',
  'à¸à¸£à¸à¸Žà¸²à¸„à¸¡','à¸ªà¸´à¸‡à¸«à¸²à¸„à¸¡','à¸à¸±à¸™à¸¢à¸²à¸¢à¸™','à¸•à¸¸à¸¥à¸²à¸„à¸¡','à¸žà¸¤à¸¨à¸ˆà¸´à¸à¸²à¸¢à¸™','à¸˜à¸±à¸™à¸§à¸²à¸„à¸¡'
];

// à¹€à¸§à¸£à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡ 1 à¸ª.à¸„.2568 â†’ à¸§à¸™à¸Šà¸¸à¸” [3,1,2]
const referenceDate = new Date(2025, 7, 1);
const rotation      = [3,1,2];

// à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸Šà¸¸à¸”à¸ªà¸·à¸šà¸ªà¸§à¸™
const teamOfficers = {
  1: [
    { rank:'à¸£.à¸•.à¸­.', name:'à¸ªà¸²à¸¢à¸±à¸“à¸«à¹Œ à¸¡à¸²à¸›à¸°à¹‚à¸—',    title:'à¸£à¸­à¸‡ à¸ªà¸§.à¸ªà¸ª.à¸¯',    code:'à¸›à¸„.412',  phone:'062-3271588' },
    { rank:'à¸£.à¸•.à¸—.', name:'à¸‰à¸±à¸•à¸£à¸Šà¸±à¸¢ à¸„à¸£à¹ˆà¸³à¸à¸£à¸°à¹‚à¸—à¸', title:'à¸£à¸­à¸‡ à¸ªà¸§.à¸ªà¸ªà¸¯',     code:'à¸›à¸„.416',  phone:'081-9224175' },
    { rank:'à¸ª.à¸•.à¸—.', name:'à¸­à¸±à¸¨à¸™à¸±à¸¢ à¹€à¸£à¸·à¸­à¸‡à¸ªà¸²à¸¢',     title:'à¸£à¸­à¸‡ à¸œà¸š.à¸«à¸¡à¸¹à¹ˆ à¸ªà¸ªà¸¯', code:'à¸›à¸„.4116', phone:'099-1719842' },
  ],
  2: [
    { rank:'à¸£.à¸•.à¸­.', name:'à¸ˆà¸³à¹€à¸£à¸´à¸ à¸—à¸´à¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ',   title:'à¸£à¸­à¸‡ à¸ªà¸§.à¸ªà¸ªà¸¯',    code:'à¸›à¸„.411',  phone:'094-9692994' },
    { rank:'à¸£.à¸•.à¸—.', name:'à¸ªà¸¡à¸„à¸´à¸” à¸šà¸±à¸§à¸¡à¸²à¸¨',       title:'à¸£à¸­à¸‡ à¸ªà¸§.à¸ªà¸ªà¸¯',    code:'à¸›à¸„.415',  phone:'083-1997055' },
    { rank:'à¸”.à¸•.', name:'à¸à¸¤à¸© à¸šà¸±à¸•à¸´à¸žà¸´à¸¡à¸²à¸¢',      title:'à¸œà¸š.à¸«à¸¡à¸¹à¹ˆ à¸›.à¸¯',   code:'à¸›à¸„.4112', phone:'098-6824652' },
    { rank:'à¸ª.à¸•.à¸­.', name:'à¸Šà¸¢à¸±à¸™à¸˜à¸£ à¹à¸¢à¸šà¸à¸£à¸°à¹‚à¸—à¸',   title:'à¸œà¸š.à¸«à¸¡à¸¹à¹ˆ à¸›.à¸¯',   code:'à¸›à¸„.4114', phone:'098-2845413' },
  ],
  3: [
    { rank:'à¸£.à¸•.à¸­.', name:'à¹€à¸à¸µà¸¢à¸£à¸•à¸´à¸¨à¸±à¸à¸”à¸´à¹Œ à¸„à¸³à¸à¸¸à¸¥',  title:'à¸£à¸­à¸‡ à¸ªà¸§.à¸ªà¸ª.à¸¯',   code:'à¸›à¸„.413',  phone:'095-8165176' },
    { rank:'à¸ª.à¸•.à¸—.', name:'à¸˜à¸µà¸£à¸° à¹‚à¸‰à¸¡à¹„à¸˜à¸ªà¸‡',        title:'à¸œà¸š.à¸«à¸¡à¸¹à¹ˆ à¸›.à¸¯',   code:'à¸›à¸„.4115', phone:'064-2066256' },
    { rank:'à¸ª.à¸•.à¸—.', name:'à¸›à¸ à¸²à¸§à¸´à¸™à¸—à¸£à¹Œ à¸—à¸´à¸žà¸¢à¹Œà¸˜à¸£à¸—à¸­à¸‡', title:'à¸œà¸š.à¸«à¸¡à¸¹à¹ˆ à¸›.à¸¯',   code:'à¸›à¸„.4116', phone:'061-9296899' },
  ]
};

function fmtThai(dt) {
  return `${dt.getDate()} ${thaiMonths[dt.getMonth()]} ${dt.getFullYear() + 543}`;
}

// à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ duty à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸±à¸™à¸™à¸±à¹‰à¸™à¹†
async function makeDutyMessageForDate(date) {
  const idx  = ((differenceInCalendarDays(date, referenceDate) % 3) + 3) % 3;
  const team = rotation[idx];
  const next = addDays(date, 1);

  const lines = [
    'à¸ªà¸ .à¸›à¸²à¸à¸„à¸¥à¸­à¸‡à¸£à¸±à¸‡à¸ªà¸´à¸• à¸ .à¸ˆà¸§.à¸›à¸—à¸¸à¸¡à¸˜à¸²à¸™à¸µ',
    '__________________',
    '',
    'à¹€à¸£à¸µà¸¢à¸™ à¸œà¸¹à¹‰à¸šà¸±à¸‡à¸„à¸±à¸šà¸šà¸±à¸à¸Šà¸²',
    `   à¸§à¸±à¸™à¸—à¸µà¹ˆ ${fmtThai(date)}`,
    '',
    `â— à¸Šà¸¸à¸”à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸à¸²à¸£ à¸ªà¸·à¸šà¸ªà¸§à¸™à¸—à¸µà¹ˆ ${team}`,
    ...teamOfficers[team].flatMap(o => [
      `${o.rank}${o.name}`,
      `${o.title} (${o.code})`,
      `à¹‚à¸—à¸£.${o.phone}`,
    ]),
    '',
    'â— à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ à¹€à¸§à¸£à¸ªà¸·à¸šà¸ªà¸§à¸™à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™à¸™à¸µà¹‰',
    `à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸§à¸±à¸™à¸—à¸µà¹ˆ ${fmtThai(date)}`,
    'à¹€à¸§à¸¥à¸² 08.00 à¸™.',
    `à¸–à¸¶à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ ${fmtThai(next)}`,
    'à¹€à¸§à¸¥à¸² 08.00 à¸™.',
    '__________________',
    '',
    '    à¸ˆà¸¶à¸‡à¹€à¸£à¸µà¸¢à¸™à¸¡à¸²à¹€à¸žà¸·à¹ˆà¸­à¹‚à¸›à¸£à¸”à¸—à¸£à¸²à¸š'
  ];

  return { type: 'text', text: lines.join('\n') };
}

// à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸•à¹ˆà¸²à¸‡ à¹† à¸‚à¸­à¸‡ @à¸™à¹‰à¸­à¸‡à¸­à¸µà¸Ÿ
const commands = [
  // 1) à¹à¸ªà¸”à¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
  {
    name: 'capabilities',
    keywords: ['à¸—à¸³à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡','à¸—à¸³à¹„à¸£à¹„à¸”à¹‰','à¸„à¸³à¸ªà¸±à¹ˆà¸‡','à¹€à¸Šà¹‡à¸„'],
    replyText:
`à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸°à¸žà¸µà¹ˆà¹† à¸«à¸™à¸¹à¸™à¹‰à¸­à¸‡à¸­à¸µà¸Ÿà¸™à¸°à¸„à¸°
à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸—à¸µà¹ˆà¸žà¸µà¹ˆà¹† à¸ªà¸±à¹ˆà¸‡à¹ƒà¸«à¹‰à¸«à¸™à¸¹à¸—à¸³à¹„à¸”à¹‰à¸„à¹ˆà¸°
__________________
1. à¹€à¸Šà¹‡à¸„à¸§à¸±à¸™à¹€à¸‚à¹‰à¸²à¹€à¸§à¸£
   - à¹€à¸§à¸£ (à¸•à¸²à¸¡à¸”à¹‰à¸§à¸¢à¸§à¸±à¸™à¹€à¸”à¸·à¸­à¸™à¸›à¸µ)

2. à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸ªà¸­à¸šà¸ªà¸§à¸™
   - à¸žà¸‡à¸ª / à¸ªà¸­à¸šà¸ªà¸§à¸™

3. à¹€à¸§à¸£à¸­à¸³à¸™à¸§à¸¢à¸à¸²à¸£à¸œà¸¹à¹‰à¹ƒà¸«à¸à¹ˆ
   - à¹€à¸§à¸£à¸­à¸³à¸™à¸§à¸¢à¸à¸²à¸£

4. à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸•à¸³à¸£à¸§à¸ˆà¸›à¸²à¸à¸„à¸¥à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
   - à¸•à¸³à¸£à¸§à¸ˆà¸›à¸²à¸à¸„à¸¥à¸­à¸‡

5. à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸›à¸£à¸°à¸ˆà¸³à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ
   - à¸ªà¸£à¸¸à¸›à¸›à¸£à¸°à¸Šà¸¸à¸¡

6. à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¸„à¹‰à¸²à¸‡à¸ªà¹ˆà¸‡ , à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸„à¹‰à¸™
   - à¸‡à¸²à¸™à¸„à¹‰à¸²à¸‡ / à¸•à¸£à¸§à¸ˆà¸„à¹‰à¸™

7. à¸«à¸™à¸¹à¹€à¸•à¹‰à¸™à¹ƒà¸«à¹‰à¸žà¸µà¹ˆà¹†à¸œà¹ˆà¸­à¸™à¸„à¸¥à¸²à¸¢
   - à¹€à¸•à¹‰à¸™

8.à¹ƒà¸«à¹‰à¸«à¸™à¸¹à¹à¸›à¸¥à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™
   (à¸­à¸¢à¸¹à¹ˆà¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸žà¸±à¸’à¸™à¸²à¸™à¸°à¸„à¸°)
   - à¹à¸›à¸¥à¸«à¸™à¹ˆà¸­à¸¢ / à¸Šà¹ˆà¸§à¸¢à¸«à¸™à¹ˆà¸­à¸¢
__________________
à¸«à¸²à¸à¸žà¸µà¹ˆà¸­à¸¢à¸²à¸à¹ƒà¸«à¹‰à¸«à¸™à¸¹à¸—à¸³à¸­à¸¢à¹ˆà¸²à¸‡à¸­à¸·à¹ˆà¸™... à¸—à¸±à¸à¸«à¸™à¸¹à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§à¸¡à¸²à¸™à¸°à¸„à¸° â¤ï¸`
  },

// 2) à¹€à¸§à¸£à¸­à¸³à¸™à¸§à¸¢à¸à¸²à¸£à¸œà¸¹à¹‰à¹ƒà¸«à¸à¹ˆ (à¸ªà¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸ à¸²à¸ž)
{
  name: 'supervisorDuty',
  keywords: ['à¹€à¸§à¸£à¸­à¸³à¸™à¸§à¸¢à¸à¸²à¸£','à¹€à¸§à¸£à¸­à¸³à¸™à¸§à¸¢à¸à¸²à¸£à¸œà¸¹à¹‰à¹ƒà¸«à¸à¹ˆ'],
  handler: async () => {
    return [
      {
        type: 'image',
        originalContentUrl: 'https://res.cloudinary.com/df5hopefn/image/upload/v1753715451/venoom-7-68_fqmrjt.jpg',
        previewImageUrl:  'https://res.cloudinary.com/df5hopefn/image/upload/v1753715451/venoom-7-68_fqmrjt.jpg'
      }
    ];
  }
},

  // 3) à¹€à¸Šà¹‡à¸„à¸§à¸±à¸™à¹€à¸‚à¹‰à¸²à¹€à¸§à¸£
  {
    name: 'duty',
    match: text => text.includes('à¹€à¸§à¸£'),
    handler: async text => {
      const m = text.match(/à¹€à¸§à¸£(?:à¸§à¸±à¸™à¸—à¸µà¹ˆ)?\s*(\d{1,2})\s*(?:à¹€à¸”à¸·à¸­à¸™\s*)?([^\s\d]+|\d{1,2})\s*(?:à¸›à¸µ\s*)?(\d{2,4})/);
      if (!m) return null;
      const [, d, mth, y] = m;
      const day = +d;
      const monthIndex = monthMap[mth] ?? (+mth - 1);
      const be = +y < 1000 ? +y + 2500 : +y;
      const ce = be - 543;
      const date = new Date(ce, monthIndex, day);
      const idx  = ((differenceInCalendarDays(date, referenceDate) % 3) + 3) % 3;
      const team = rotation[idx];
      const next = addDays(date, 1);

      const lines = [
        'à¸ªà¸ .à¸›à¸²à¸à¸„à¸¥à¸­à¸‡à¸£à¸±à¸‡à¸ªà¸´à¸• à¸ .à¸ˆà¸§.à¸›à¸—à¸¸à¸¡à¸˜à¸²à¸™à¸µ',
        '__________________',
        '',
        'à¹€à¸£à¸µà¸¢à¸™ à¸œà¸¹à¹‰à¸šà¸±à¸‡à¸„à¸±à¸šà¸šà¸±à¸à¸Šà¸²',
        `   à¸§à¸±à¸™à¸—à¸µà¹ˆ ${fmtThai(date)}`,
        '',
        `â— à¸Šà¸¸à¸”à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸à¸²à¸£ à¸ªà¸·à¸šà¸ªà¸§à¸™à¸—à¸µà¹ˆ ${team}`,
        ...teamOfficers[team].flatMap(o => [
          `${o.rank}${o.name}`,
          `${o.title} (${o.code})`,
          `à¹‚à¸—à¸£.${o.phone}`,
        ]),
        '',
        'â— à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ à¹€à¸§à¸£à¸ªà¸·à¸šà¸ªà¸§à¸™à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™à¸™à¸µà¹‰',
        `à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸§à¸±à¸™à¸—à¸µà¹ˆ ${fmtThai(date)}`,
        'à¹€à¸§à¸¥à¸² 08.00 à¸™.',
        `à¸–à¸¶à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ ${fmtThai(next)}`,
        'à¹€à¸§à¸¥à¸² 08.00 à¸™.',
        '__________________',
        '',
        '    à¸ˆà¸¶à¸‡à¹€à¸£à¸µà¸¢à¸™à¸¡à¸²à¹€à¸žà¸·à¹ˆà¸­à¹‚à¸›à¸£à¸”à¸—à¸£à¸²à¸š'
      ];
      return { type:'text', text: lines.join('\n') };
    }
  },

  // 4) à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸ªà¸­à¸šà¸ªà¸§à¸™
  {
    name: 'investigators',
    keywords: ['à¸žà¸‡à¸ª','à¸ªà¸­à¸šà¸ªà¸§à¸™'],
    replyText:
`à¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸ªà¸­à¸šà¸ªà¸§à¸™ à¸ªà¸ .à¸›à¸²à¸à¸„à¸¥à¸­à¸‡à¸£à¸±à¸‡à¸ªà¸´à¸•
à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£ 02-501 2298
02-501 2892
FAX 02-501 2951
__________________

à¸ž.à¸•.à¸—.à¹€à¸™à¸•à¸´ à¸£à¸¸à¹ˆà¸‡à¸Ÿà¹‰à¸²à¹à¸ªà¸‡à¸­à¸£à¸¸à¸“
à¸£à¸­à¸‡ à¸œà¸à¸.(à¸ªà¸­à¸šà¸ªà¸§à¸™)
à¹‚à¸—à¸£.094-1653616
(à¸«à¸±à¸§à¸«à¸™à¹‰à¸² à¸žà¸‡à¸ª.)

à¸ž.à¸•.à¸—.à¸§à¸¸à¸’à¸´ à¸žà¸£à¸°à¹€à¸”à¸Šà¸§à¸‡à¸©à¹Œ
à¸ªà¸§.(à¸ªà¸­à¸šà¸ªà¸§à¸™)à¸¯
à¹‚à¸—à¸£.063-7698029
(à¸«à¸±à¸§à¸«à¸™à¹‰à¸²à¸‡à¸²à¸™à¸„à¸”à¸µ)

à¸ž.à¸•.à¸—.à¸à¸§à¸µ à¸Šà¹ˆà¸§à¸¢à¸ªà¸£à¹‰à¸²à¸‡
à¸ªà¸§.(à¸ªà¸­à¸šà¸ªà¸§à¸™)à¸¯
à¹‚à¸—à¸£.086-5141000

à¸ž.à¸•.à¸—.à¸ªà¸¸à¸§à¸±à¸’à¸™à¹Œ à¹‚à¸žà¸˜à¸´à¹Œà¸£à¸µ
à¸ªà¸§.(à¸ªà¸­à¸šà¸ªà¸§à¸™)à¸¯
à¹‚à¸—à¸£.089-1142213

à¸ž.à¸•.à¸•.à¸«à¸à¸´à¸‡ à¸­à¸±à¸ˆà¸‰à¸£à¸² à¸à¸£à¸°à¹€à¸•à¸·à¹‰à¸­à¸‡à¸‡à¸²à¸™
à¸ªà¸§.(à¸ªà¸­à¸šà¸ªà¸§à¸™)à¸¯
à¹‚à¸—à¸£.081-5195559

à¸£.à¸•.à¸—.à¸žà¸´à¸ªà¸´à¸©à¸à¹Œ à¸ˆà¸­à¸‡à¸ˆà¸²à¸£à¸¸à¸§à¸‡à¸¨à¹Œ
à¸£à¸­à¸‡ à¸ªà¸§.(à¸ªà¸­à¸šà¸ªà¸§à¸™)à¸¯
à¹‚à¸—à¸£.086-3466493

à¸£.à¸•.à¸—.à¸žà¸‡à¸¨à¸˜à¸£ à¹à¸¥à¹€à¸¥à¸´à¸¨
à¸£à¸­à¸‡ à¸ªà¸§.(à¸ªà¸­à¸šà¸ªà¸§à¸™)à¸¯
à¹‚à¸—à¸£.065-9981462

à¸£.à¸•.à¸—.à¸«à¸à¸´à¸‡ à¸§à¸ªà¸¸à¸à¸±à¸à¸à¸² à¸˜à¸Šà¸µà¸žà¸±à¸™à¸˜à¹Œ
à¸£à¸­à¸‡ à¸ªà¸§.(à¸ªà¸­à¸šà¸ªà¸§à¸™)à¸¯
à¹‚à¸—à¸£.091-0287794
__________________

    à¸ˆà¸¶à¸‡à¹€à¸£à¸µà¸¢à¸™à¸¡à¸²à¹€à¸žà¸·à¹ˆà¸­à¹‚à¸›à¸£à¸”à¸—à¸£à¸²à¸š`
  },

// 5) à¸ªà¸£à¸¸à¸›à¸›à¸£à¸°à¸Šà¸¸à¸¡
{
  name: 'meetingSummary',
  keywords: ['à¸ªà¸£à¸¸à¸›à¸›à¸£à¸°à¸Šà¸¸à¸¡','à¸›à¸£à¸°à¸Šà¸¸à¸¡'],
  handler: async () => {
    // à¸­à¹ˆà¸²à¸™à¸—à¸¸à¸à¹à¸–à¸§à¸ˆà¸²à¸à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ Aâ€“G
    const rows = await getSheetData(SHEET_ID, "'Meet'!A2:G100");

    // à¸•à¸±à¸” cell à¸—à¸µà¹ˆà¸§à¹ˆà¸²à¸‡ à¹à¸¥à¹‰à¸§ join à¸”à¹‰à¸§à¸¢ space
    const lines = rows.map(r =>
      r
        .filter(cell => cell !== null && cell !== '')
        .join(' ')
    );

    return {
      type: 'text',
      text: `à¸ªà¸£à¸¸à¸›à¸à¸²à¸£à¸›à¸£à¸°à¸Šà¸¸à¸¡à¸›à¸£à¸°à¸ˆà¸³à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸™à¸µà¹‰:\n${lines.join('\n')}`
    };
  }
},

// 6) à¸‡à¸²à¸™à¸„à¹‰à¸²à¸‡ / à¸•à¸£à¸§à¸ˆà¸„à¹‰à¸™ (1 à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ = 1 à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡)
{
  name: 'backlog',
  keywords: ['à¸‡à¸²à¸™à¸„à¹‰à¸²à¸‡','à¸•à¸£à¸§à¸ˆà¸„à¹‰à¸™'],
  handler: async () => {
    // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¹à¸—à¹‡à¸š "Work" (à¸›à¸£à¸±à¸š range à¸•à¸²à¸¡à¸ˆà¸£à¸´à¸‡à¹„à¸”à¹‰)
    const rows = await getSheetData(SHEET_ID, "'Work'!A2:Z100");
    // à¸«à¸²à¹€à¸¥à¸‚à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸ªà¸¹à¸‡à¸ªà¸¸à¸”
    const maxCols = rows.reduce((m, r) => Math.max(m, r.length), 0);

    const messages = [];
    for (let col = 0; col < maxCols; col++) {
      // à¹€à¸à¹‡à¸šà¹€à¸‰à¸žà¸²à¸°à¸„à¹ˆà¸²à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸‡à¸‚à¸­à¸‡à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸™à¸µà¹‰
      const items = rows
        .map(r => r[col])
        .filter(cell => cell != null && cell !== '');

      if (items.length === 0) continue;  // à¸‚à¹‰à¸²à¸¡à¸–à¹‰à¸²à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¹€à¸›à¸¥à¹ˆà¸²

      // à¹ƒà¸ªà¹ˆ header à¹à¸„à¹ˆà¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¹à¸£à¸
      const header = col === 0 ? 'à¸‡à¸²à¸™à¸„à¹‰à¸²à¸‡à¹à¸¥à¸°à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸„à¹‰à¸™:\n\n' : '';
      // join à¸”à¹‰à¸§à¸¢à¸šà¸£à¸£à¸—à¸±à¸”à¸§à¹ˆà¸²à¸‡
      const text = header + items.join('\n\n');

      messages.push({ type:'text', text });
    }

    return messages;
  }
},

// 7) à¸•à¸³à¸£à¸§à¸ˆà¸›à¸²à¸à¸„à¸¥à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
{
  name: 'allPolice',
  keywords: ['à¸•à¸³à¸£à¸§à¸ˆà¸›à¸²à¸à¸„à¸¥à¸­à¸‡'],
  handler: async () => {
    const rows = await getSheetData(SHEET_ID, POLICE_RANGE);

    // à¹à¸¢à¸à¹€à¸›à¹‡à¸™ sections à¸•à¸²à¸¡à¸«à¸±à¸§à¸‚à¹‰à¸­à¹à¸œà¸™à¸
    const sections = [];
    let current = null;
    for (const r of rows) {
      const [col0, col1, , col3, col4, col5] = r;
      if (col0 && !col1 && !col3 && !col4 && !col5) {
        current = [`â— ${col0.trim()}`];
        sections.push(current);
      } else if (col0 && col1 && current) {
        const name     = r.slice(1,3).filter(Boolean).join(' ');
        const pos      = col3 || '-';
        const callSign = col4 || '';
        const phone    = col5 ? `à¹‚à¸—à¸£.${col5}` : '';

        let entry = `${col0}. ${name}\n   à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ : ${pos}\n`;
        if (callSign) entry += `   ${callSign}\n`;
        if (phone)    entry += `   ${phone}`;
        current.push(entry);
      }
    }

    // à¹à¸šà¹ˆà¸‡à¹€à¸›à¹‡à¸™à¸à¹‰à¸­à¸™ à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 5 à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
    const header = 'à¸ªà¸ .à¸›à¸²à¸à¸„à¸¥à¸­à¸‡à¸£à¸±à¸‡à¸ªà¸´à¸• à¸ .à¸ˆà¸§.à¸›à¸—à¸¸à¸¡à¸˜à¸²à¸™à¸µ\n__________________';
    const chunks = [];
    let buf = header;
    for (const sect of sections) {
      const text = '\n' + sect.join('\n');
      // à¸–à¹‰à¸²à¹€à¸à¸´à¸™ 1500 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£ à¸«à¸£à¸·à¸­à¹€à¸à¸´à¸™ 5 à¸à¹‰à¸­à¸™ à¹ƒà¸«à¹‰à¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ
      if (buf.length + text.length > 1500 || chunks.length >= 4) {
        chunks.push(buf);
        buf = header + text;
      } else {
        buf += text;
      }
    }
    chunks.push(buf);

    // à¸•à¸±à¸”à¹ƒà¸«à¹‰à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 5 à¸à¹‰à¸­à¸™
    return chunks.slice(0, 5).map(t => ({ type:'text', text: t }));
  }
},

  // 8) à¹€à¸•à¹‰à¸™
  {
    name: 'dance',
    keywords: ['à¹€à¸•à¹‰à¸™'],
    handler: () => ({
      type: 'image',
      originalContentUrl: 'https://res.cloudinary.com/df5hopefn/image/upload/v1753664460/evedance_opnkib.gif',
      previewImageUrl:  'https://res.cloudinary.com/df5hopefn/image/upload/v1753664460/evedance_opnkib.gif'
    })
  },

  // 9) à¸—à¸±à¸à¸—à¸²à¸¢
  {
    name: 'greet',
    keywords: ['à¸ªà¸§à¸±à¸ªà¸”à¸µ','à¸”à¸µà¸„à¹ˆà¸°','à¸”à¸µà¸ˆà¹Šà¸°','à¸”à¸µà¸„à¸±à¸š'],
    replyText: 'à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸² à¸™à¹‰à¸­à¸‡à¸­à¸µà¸Ÿà¸¡à¸²à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸° â¤ï¸'
  },

// 10) à¸žà¸¹à¸”à¸„à¸¸à¸¢ OpenAI
{
  name: 'askAI',
  keywords: ['à¹à¸›à¸¥à¸«à¸™à¹ˆà¸­à¸¢','AI','à¸Šà¹ˆà¸§à¸¢à¸«à¸™à¹ˆà¸­à¸¢'],
  handler: async (text) => {
    try {
      const resp = await openai.chat.completions.create({
        model: 'gpt-4o-mini',
        messages: [{ role: 'user', content: text }]
      });
      return { type:'text', text: resp.choices[0].message.content };
    } catch (err) {
      console.error('OpenAI error:', err);
      if (err.code === 'insufficient_quota' || err.status === 429) {
        return {
          type: 'text',
          text: 'à¸‚à¸­à¹‚à¸—à¸©à¸™à¸°à¸„à¸° à¹‚à¸„à¸§à¸•à¹‰à¸²à¸‚à¸­à¸‡ OpenAI à¸«à¸¡à¸”à¹à¸¥à¹‰à¸§ à¸£à¸­à¸«à¸™à¸¹à¸«à¸™à¹ˆà¸­à¸¢à¸™à¸°à¸„à¸°à¸žà¸µà¹ˆà¹† ðŸ˜­'
        };
      }
      return {
        type: 'text',
        text: 'à¸‚à¸­à¹‚à¸—à¸©à¸„à¹ˆà¸° à¸«à¸™à¸¹à¸¢à¸±à¸‡à¹€à¸£à¸µà¸¢à¸ AI à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¹„à¸§à¹‰à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡à¸™à¸°à¸„à¸°'
      };
    }
  }
},

{
  name: 'translateReport',
  match: (text, ev) => ev.message.type === 'image' && text.includes('à¹à¸›à¸¥'),
  handler: async (text, ev) => {
    const stream = await client.getMessageContent(ev.message.id);
    const chunks = [];
    for await (const chunk of stream) chunks.push(chunk);
    const buffer = Buffer.concat(chunks);

    const ocr = await extractTextFromImage(buffer);
    if (!ocr) return { type:'text', text:'à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸™à¸ à¸²à¸ž à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ' };

    const translated = await translateText(ocr);

    // à¸«à¸²à¸«à¸±à¸§à¸«à¸™à¹‰à¸²à¸Šà¸¸à¸”à¹€à¸§à¸£ à¸Šà¹ˆà¸§à¸‡à¸™à¸µà¹‰à¸ªà¸¡à¸¡à¸•à¸´à¹€à¸›à¹‡à¸™ teamOfficers[1][0]
    const lead = teamOfficers[1][0];

    const report = await formatReport(translated, lead);
    return { type:'text', text: report };
  }
},

  // 11) à¸„à¸¸à¸“à¸Šà¸·à¹ˆà¸­à¸­à¸°à¹„à¸£
  {
    name: 'whoami',
    keywords: ['à¸„à¸¸à¸“à¸Šà¸·à¹ˆà¸­à¸­à¸°à¹„à¸£','à¸Šà¸·à¹ˆà¸­à¹„à¸£','à¸Šà¸·à¹ˆà¸­','à¹ƒà¸„à¸£'],
    replyText: 'à¸«à¸™à¸¹à¸Šà¸·à¹ˆà¸­ à¸™à¹‰à¸­à¸‡à¸­à¸µà¸Ÿ à¸„à¹ˆà¸° ðŸ˜Š'
  },

  // 11) fallback
  {
    name: 'fallback',
    keywords: [],
    replyText: 'à¸„à¹ˆà¸²à¸²à¸²à¸žà¸µà¹ˆ à¹€à¸£à¸µà¸¢à¸à¸«à¸™à¸¹à¸«à¸£à¸­à¸„à¸° à¸žà¸µà¹ˆà¸¥à¸­à¸‡à¸žà¸´à¸¡à¸žà¹Œ @à¸™à¹‰à¸­à¸‡à¸­à¸µà¸Ÿ à¸—à¸³à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡ à¸”à¸¹à¸™à¸°à¸„à¸° ðŸ˜Š'
  }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Webhook handler
export default async function handler(req, res) {
  if (req.method === 'GET') return res.status(200).end();
  if (req.method !== 'POST') return res.status(405).end();

  try {
    await middleware(config)(req, res, () => Promise.resolve());
  } catch {
    return res.status(401).end();
  }

  for (const ev of req.body.events || []) {
    // â‘  Logging à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š source à¸‚à¸­à¸‡ event
    console.log('>>> Received event source:', ev.source);
    if (ev.source.groupId) {
      console.log('>>> Group ID is:', ev.source.groupId);
    }

    if (ev.type !== 'message' || ev.message.type !== 'text') continue;
    const raw  = ev.message.text;
    if (!raw.includes('@à¸™à¹‰à¸­à¸‡à¸­à¸µà¸Ÿ')) continue;
    const text = raw.replace(/@à¸™à¹‰à¸­à¸‡à¸­à¸µà¸Ÿ/g, '').trim();

    let replied = false;
    for (const cmd of commands) {
      const ok = cmd.match
        ? cmd.match(text)
        : cmd.keywords.some(k => text.includes(k));
      if (!ok) continue;
      replied = true;

      if (cmd.replyText) {
        await client.replyMessage(ev.replyToken, { type:'text', text: cmd.replyText });
      } else if (cmd.handler) {
        const result = await cmd.handler(text);
        if (Array.isArray(result)) {
          await client.replyMessage(ev.replyToken, result);
        } else if (result) {
          await client.replyMessage(ev.replyToken, [ result ]);
        }
      }
      break;
    }

    if (!replied) {
      const fb = commands.find(c => c.name === 'fallback');
      await client.replyMessage(ev.replyToken, { type:'text', text: fb.replyText });
    }
  }

  return res.status(200).end();
}